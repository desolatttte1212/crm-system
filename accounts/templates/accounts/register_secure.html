{% extends "accounts/base.html" %}
{% block title %}Регистрация{% endblock %}
{% block content %}
<h3>Создайте аккаунт</h3>

{% if error %}
    <div class="alert">{{ error }}</div>
{% endif %}

<form id="register-form" method="post" action="{% url 'register' %}">
    {% csrf_token %}
    <div class="form-group">
        <label>Имя пользователя</label>
        <input type="text" name="username" required>
    </div>
    <div class="form-group">
        <label>Email</label>
        <input type="email" name="email" required>
    </div>
    <div class="form-group">
        <label>Пароль</label>
        <input type="password" id="password" name="password" required>
        <!-- Подсказка для пароля -->
        <small id="password-hint" class="text-danger" style="display: block; margin-top: 0.5rem; font-size: 0.85rem;">
            Пароль должен содержать минимум 8 символов, включать буквы, цифры и спецсимволы (!@#$%^&*).
        </small>
    </div>
    <div class="form-group">
        <label>Повторите пароль</label>
        <input type="password" id="password2" name="password2" required>
        <small id="password-match" class="text-danger" style="display: none;">Пароли не совпадают</small>
    </div>
    <div class="form-check">
        <input type="checkbox" id="policy" name="policy_accepted" required>
        <label for="policy">
            Я принимаю <a href="#" class="text-decoration-none">политику конфиденциальности</a>
        </label>
    </div>
    <input type="hidden" name="hashed_password" id="hashed_password">
    <button type="submit">Зарегистрироваться</button>
</form>

<p class="link">
    Уже есть аккаунт?
    <a href="{% url 'login' %}">Войдите</a>
</p>

<!-- Подключаем CryptoJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<!-- JS для проверок и шифрования -->
<script>
    const passwordInput = document.getElementById("password");
    const passwordHint = document.getElementById("password-hint");
    const passwordMatch = document.getElementById("password-match");
    const password2Input = document.getElementById("password2");

    // Проверка сложности пароля
    function validatePassword(password) {
        const minLength = password.length >= 8;
        const hasLetter = /[a-zA-Z]/.test(password);
        const hasDigit = /\d/.test(password);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
        return minLength && hasLetter && hasDigit && hasSpecial;
    }

    // Обновляем подсказку
    passwordInput.addEventListener("input", function () {
        const password = passwordInput.value;
        if (password && !validatePassword(password)) {
            passwordHint.style.display = "block";
            passwordHint.style.color = "#c62828";
        } else {
            passwordHint.style.display = "none";
        }

        // Проверяем совпадение паролей
        if (password2Input.value && password !== password2Input.value) {
            passwordMatch.style.display = "block";
        } else {
            passwordMatch.style.display = "none";
        }
    });

    password2Input.addEventListener("input", function () {
        const pass1 = passwordInput.value;
        const pass2 = password2Input.value;
        if (pass1 && pass2 && pass1 !== pass2) {
            passwordMatch.style.display = "block";
        } else {
            passwordMatch.style.display = "none";
        }
    });

    // При отправке формы
    document.getElementById("register-form").addEventListener("submit", function (e) {
        const pass1 = passwordInput.value;
        const pass2 = password2Input.value;
        const policy = document.getElementById("policy");

        let isValid = true;

        // Проверка совпадения
        if (pass1 !== pass2) {
            passwordMatch.style.display = "block";
            isValid = false;
        } else {
            passwordMatch.style.display = "none";
        }

        // Проверка сложности
        if (!validatePassword(pass1)) {
            passwordHint.style.display = "block";
            passwordHint.style.color = "#c62828";
            isValid = false;
        }

        // Проверка политики
        if (!policy.checked) {
            alert("Пожалуйста, примите политику конфиденциальности");
            isValid = false;
        }

        if (!isValid) {
            e.preventDefault();
            return;
        }

        // Хэшируем пароль
        const username = document.querySelector("input[name='username']").value;
        const salt = username;
        const key = CryptoJS.PBKDF2(pass1, salt, {
            keySize: 256 / 32,
            iterations: 10000
        });
        document.getElementById("hashed_password").value = key.toString();
    });
</script>
{% endblock %}