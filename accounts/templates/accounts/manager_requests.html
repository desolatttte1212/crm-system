<!-- templates/accounts/manager_requests.html -->
{% extends "accounts/base_dashboard.html" %}
{% block title %}–ú–æ–∏ –∑–∞—è–≤–∫–∏{% endblock %}
{% block header %}–ú–æ–∏ –∑–∞—è–≤–∫–∏{% endblock %}
{% block content %}
<div class="card">
    <!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <form method="get" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem; align-items: end;">
        <!-- –ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä—É -->
        <div>
            <label>–¢–æ–≤–∞—Ä</label>
            <input type="text" name="search" value="{{ search }}" placeholder="–ü–æ–∏—Å–∫..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--text);">
        </div>

        <!-- –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É -->
        <div>
            <label>–ö–ª–∏–µ–Ω—Ç</label>
            <input type="text" name="client" value="{{ client }}" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--text);">
        </div>

        <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
        <div>
            <label>–°—Ç–∞—Ç—É—Å</label>
            <select name="status" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--text);">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                {% for value, label in STATUS_CHOICES %}
                    {% if value not in 'completed,cancelled' %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
        <div style="display: flex; gap: 0.5rem;">
            <div style="flex: 1;">
                <label>–û—Ç</label>
                <input type="date" name="date_from" value="{{ date_from }}" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--text);">
            </div>
            <div style="flex: 1;">
                <label>–î–æ</label>
                <input type="date" name="date_to" value="{{ date_to }}" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--text);">
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏ Excel -->
        <div style="display: grid; gap: 0.5rem;">
            <button type="submit" class="btn btn-primary" style="height: fit-content;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <a href="{% url 'export_requests_excel' %}" class="btn btn-primary" style="background-color: #28a745; height: fit-content;">
                üì• –°–∫–∞—á–∞—Ç—å Excel
            </a>
        </div>
    </form>

    <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
    <div style="margin-bottom: 1.5rem;">
        <label>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
        <div style="margin-top: 0.5rem;">
            <a href="?{{ filters }}&sort=date_asc" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.9rem;">–ü–æ –¥–∞—Ç–µ ‚Üë</a>
            <a href="?{{ filters }}&sort=date_desc" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.9rem;">–ü–æ –¥–∞—Ç–µ ‚Üì</a>
        </div>
    </div>

    {% if requests %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                <thead>
                    <tr style="border-bottom: 2px solid var(--border);">
                        <th style="padding: 1rem; text-align: left; color: var(--primary-light);">ID</th>
                        <th style="padding: 1rem; text-align: left; color: var(--primary-light);">–ö–ª–∏–µ–Ω—Ç</th>
                        <th style="padding: 1rem; text-align: left; color: var(--primary-light);">–¢–æ–≤–∞—Ä</th>
                        <th style="padding: 1rem; text-align: left; color: var(--primary-light);">–ö–æ–ª-–≤–æ</th>
                        <th style="padding: 1rem; text-align: left; color: var(--primary-light);">–°—Ç–∞—Ç—É—Å</th>
                        <th style="padding: 1rem; text-align: left; color: var(--primary-light);">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</th>
                        <th style="padding: 1rem; text-align: left; color: var(--primary-light);">–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 1rem; color: var(--text);">{{ req.id }}</td>
                            <td style="padding: 1rem; color: var(--text);">
                                {{ req.user.profile.company_name|default:req.user.profile.full_name|default:req.user.username }}
                            </td>
                            <td style="padding: 1rem; color: var(--text);">{{ req.product_name }}</td>
                            <td style="padding: 1rem; color: var(--text);">{{ req.quantity }}</td>
                            <td style="padding: 1rem;">
                                <form method="post" action="{% url 'update_request_status' req.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <select name="status" onchange="this.form.submit()"
                                            style="padding: 0.4rem; border: 1px solid var(--border); border-radius: 6px; background: rgba(255,255,255,0.05); color: var(--text);">
                                        {% for value, label in req.STATUS_CHOICES %}
                                            <option value="{{ value }}" {% if req.status == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </form>
                            </td>
                            <td style="padding: 1rem;">
                                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –ö–¢–û -->
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; color: var(--primary-light); font-size: 0.95rem;">
                                        <i class="fas fa-user-tie" style="color: #4dabf7;"></i> –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –ö–¢–û
                                    </label>
                                    {% if req.cto_comment %}
                                        <div style="
                                            padding: 0.75rem;
                                            border: 1px solid var(--border);
                                            border-radius: 6px;
                                            background: rgba(26, 115, 232, 0.1);
                                            color: var(--text);
                                            font-size: 0.95rem;
                                            white-space: pre-wrap;
                                            min-height: 80px;
                                        ">
                                            {{ req.cto_comment }}
                                        </div>
                                    {% else %}
                                        <div style="
                                            padding: 0.75rem;
                                            border: 1px dashed var(--border);
                                            border-radius: 6px;
                                            color: var(--text-muted);
                                            font-size: 0.95rem;
                                            text-align: center;
                                            background: rgba(255, 255, 255, 0.03);
                                        ">
                                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫–ª–∏–µ–Ω—Ç—É -->
                                <div style="margin-bottom: 1.5rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; color: var(--primary-light); font-size: 0.95rem;">
                                        <i class="fas fa-comment" style="color: #28a745;"></i> –í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫–ª–∏–µ–Ω—Ç—É
                                    </label>
                                    <form method="post" action="{% url 'add_comment' req.id %}">
                                        {% csrf_token %}
                                        <textarea name="comment" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É..." style="
                                            width: 100%;
                                            padding: 0.75rem;
                                            border: 1px solid var(--border);
                                            border-radius: 6px;
                                            background: rgba(255,255,255,0.05);
                                            color: var(--text);
                                            min-height: 80px;
                                            font-size: 0.95rem;
                                        ">{{ req.manager_comment|default:'' }}</textarea>
                                        <button type="submit" class="btn btn-primary" style="font-size: 0.9rem; padding: 0.4rem 0.8rem; margin-top: 0.5rem;">
                                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                                        </button>
                                    </form>
                                </div>
                            </td>
                            <td style="padding: 1rem;">
                                <span style="font-size: 0.9rem; color: var(--text-muted);">
                                    {{ req.created_at|date:"d M, H:i" }}
                                </span>
                            </td>
                        </tr>

                        <!-- –ë–ª–æ–∫: –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ -->
                        {% if req.status == 'awaiting_documents' and not req.signed_contract_file and not req.invoice_file %}
                            <tr style="background: rgba(26, 115, 232, 0.05);">
                                <td colspan="7" style="padding: 1.5rem;">
                                    <div style="border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; background: rgba(26, 115, 232, 0.08);">
                                        <h4 style="margin: 0 0 1rem; color: var(--primary-light);">–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h4>
                                        <p style="color: var(--text-muted); margin-bottom: 1rem;">
                                            –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–∏—Ä–µ–∫—Ç–æ—Ä—É –∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É.
                                        </p>
                                        <form method="post" action="{% url 'send_to_ceo_and_accountant' req.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-primary">
                                                üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã (–¥–∏—Ä–µ–∫—Ç–æ—Ä—É –∏ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—É)
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}

                        <!-- –ë–ª–æ–∫: –¥–æ–∫—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã -->
                        {% if req.status == 'awaiting_documents' and req.signed_contract_file and req.invoice_file %}
                            <tr style="background: rgba(40, 167, 69, 0.1);">
                                <td colspan="7" style="padding: 1.5rem;">
                                    <div style="border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; background: rgba(40, 167, 69, 0.1);">
                                        <h4 style="margin: 0 0 1rem; color: var(--primary-light);">–î–æ–∫—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã</h4>
                                        <p>
                                            <a href="{{ req.signed_contract_file.url }}" target="_blank" class="doc-link">
                                                <i class="fas fa-file-contract"></i> –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä
                                            </a>
                                        </p>
                                        <p>
                                            <a href="{{ req.invoice_file.url }}" target="_blank" class="doc-link">
                                                <i class="fas fa-file-invoice"></i> –°—á—ë—Ç
                                            </a>
                                        </p>
                                        <form method="post" action="{% url 'send_documents_to_client' req.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-primary">
                                                ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}

                        <!-- –ë–ª–æ–∫: –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–ø–∏—Å–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç—ã -->
                        {% if req.status == 'signed_by_client' and req.client_signed_contract and req.client_signed_invoice %}
                            <tr style="background: rgba(40, 167, 69, 0.1);">
                                <td colspan="7" style="padding: 1.5rem;">
                                    <div style="border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; background: rgba(40, 167, 69, 0.1);">
                                        <h4 style="margin: 0 0 1rem; color: var(--primary-light);">–ö–ª–∏–µ–Ω—Ç –ø–æ–¥–ø–∏—Å–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç—ã</h4>
                                        <p>
                                            <a href="{{ req.client_signed_contract.url }}" target="_blank" class="doc-link">
                                                <i class="fas fa-file-signature"></i> –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä
                                            </a>
                                        </p>
                                        <p>
                                            <a href="{{ req.client_signed_invoice.url }}" target="_blank" class="doc-link">
                                                <i class="fas fa-file-signature"></i> –ü–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–π —Å—á—ë—Ç
                                            </a>
                                        </p>
                                        <form method="post" action="{% url 'send_to_production' req.id %}" style="margin-top: 1rem;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-primary">
                                                ‚úÖ –ü–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}

                        <!-- –ë–ª–æ–∫: –æ—Ç–≥—Ä—É–∑–æ—á–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã -->
                        {% if req.status == 'shipping_docs_ready' and req.shipping_docs %}
                            <tr style="background: rgba(26, 115, 232, 0.05);">
                                <td colspan="7" style="padding: 1.5rem;">
                                    <div style="border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; background: rgba(26, 115, 232, 0.08);">
                                        <h4 style="margin: 0 0 1rem; color: var(--primary-light);">–û—Ç–≥—Ä—É–∑–æ—á–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –≥–æ—Ç–æ–≤—ã</h4>
                                        <p>
                                            <a href="{{ req.shipping_docs.url }}" target="_blank" class="doc-link">
                                                <i class="fas fa-truck"></i> –û—Ç–≥—Ä—É–∑–æ—á–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
                                            </a>
                                        </p>
                                        <form method="post" action="{% url 'send_shipping_docs_to_client' req.id %}" style="margin-top: 1rem;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-primary">
                                                ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}

                        <!-- –ë–ª–æ–∫: –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–ø–∏—Å–∞–ª –æ—Ç–≥—Ä—É–∑–∫—É -->
                        {% if req.status == 'client_signed_shipping' and req.client_signed_shipping_docs %}
                            <tr style="background: rgba(26, 115, 232, 0.05);">
                                <td colspan="7" style="padding: 1.5rem;">
                                    <div style="border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; background: rgba(26, 115, 232, 0.08);">
                                        <h4 style="margin: 0 0 1rem; color: var(--primary-light);">–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã</h4>
                                        <p>–ö–ª–∏–µ–Ω—Ç –ø–æ–¥–ø–∏—Å–∞–ª –æ—Ç–≥—Ä—É–∑–æ—á–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –û–∂–∏–¥–∞–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ –ø–æ —Å—á—ë—Ç—É.</p>
                                        <form method="post" action="{% url 'mark_as_awaiting_payment' req.id %}" style="margin-top: 1rem;">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-primary">
                                                ‚úÖ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ "–û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–ª–∞—Ç—ã"
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                        {% endif %}

                        <!-- –ë–ª–æ–∫: –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ/–æ—Ç–º–µ–Ω—ë–Ω–Ω—ã–µ -->
                        {% if req.status in 'completed,cancelled' %}
                            <tr style="background: rgba(100, 100, 100, 0.1);">
                                <td colspan="7" style="padding: 1rem; text-align: center; color: var(--text-muted); font-style: italic;">
                                    –ó–∞—è–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤
                                </td>
                            </tr>
                        {% endif %}

                        <!-- üîΩ –ù–û–í–û–ï: –ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞ -->
                        {% if req.status == 'cancelled' and req.client_rejection_reason %}
                            <tr style="background: rgba(220, 53, 69, 0.1);">
                                <td colspan="7" style="padding: 1rem; color: #dc3545; font-weight: 500; font-size: 0.95rem;">
                                    <i class="fas fa-times-circle"></i>
                                    <strong>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã:</strong> {{ req.client_rejection_reason }}
                                </td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p style="text-align: center; color: var(--text-muted); padding: 2rem;">
            –ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
        </p>
    {% endif %}
</div>
{% endblock %}