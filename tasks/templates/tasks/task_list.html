{% extends 'accounts/base_dashboard.html' %}

{% block header %}–ó–∞–¥–∞—á–∏{% endblock %}

{% block content %}
<style>
    .custom-form-container {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        margin-bottom: 2rem;
    }
    .custom-form-container h5 {
        color: var(--primary-light);
        margin-bottom: 1.5rem;
    }
    .form-row-gap {
        display: flex;
        flex-wrap: wrap;
        gap: 0 1.5rem; /* –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø */
        row-gap: 30px; /* –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø 30px */
    }
    .form-field {
        flex: 1 1 300px; /* –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
        min-width: 250px;
    }
    .form-field label {
        display: block;
        margin-bottom: 0.5rem;
        color: var(--text);
        font-weight: 500;
    }
    .form-field input, .form-field textarea {
        width: 100%;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
    }
    .form-field select {
        width: 100%;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: black; /* ‚úÖ –ß—ë—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ */
    }
    .form-field input:focus, .form-field textarea:focus, .form-field select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    .custom-table-container {
        background: var(--card-bg);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    .custom-table-container table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 0; /* —É–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É —è—á–µ–π–∫–∞–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    }
    .custom-table-container th {
        background-color: var(--sidebar-bg);
        padding: 1rem 39px; /* 39px –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø */
        text-align: center; /* ‚úÖ –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        color: var(--primary-light);
        font-weight: 600;
    }
    .custom-table-container td {
        padding: 1rem 39px; /* 39px –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø */
        border-bottom: 1px solid var(--border);
        color: var(--text);
        vertical-align: middle; /* ‚úÖ –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É —è—á–µ–π–∫–∏ */
        text-align: center; /* ‚úÖ –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–æ–ª–±—Ü–∞ */
    }
    .custom-table-container tbody tr:nth-of-type(odd) {
        background-color: rgba(255, 255, 255, 0.03);
    }
    .custom-table-container tbody tr:hover {
        background-color: rgba(26, 115, 232, 0.1);
    }

    .priority-indicator {
        display: inline-block;
        width: 24px; /* ‚úÖ –í 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ */
        height: 24px; /* ‚úÖ –í 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ */
        border-radius: 50%;
        cursor: pointer; /* ‚úÖ –ö—É—Ä—Å–æ—Ä-–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ */
    }
    .priority-form {
        display: inline-block;
    }
    .priority-form select {
        width: auto;
        padding: 0.25rem;
        font-size: 0.8rem;
        border: none;
        background: transparent;
        outline: none;
    }

    .status-form {
        display: inline-block;
    }
    .status-form select {
        padding: 0.25rem;
        font-size: 0.9rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
    }

    .delete-btn {
        padding: 0.25rem 0.5rem;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    .delete-btn:hover {
        background: #c82333;
    }

    .description-cell {
        text-align: left; /* ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
        padding-top: 0; /* ‚úÖ –£–±–∏—Ä–∞–µ–º –≤–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
    }
    .description-form {
        display: inline-block;
        width: 100%;
    }
    .description-form textarea {
        width: 100%;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        resize: vertical;
    }
    .description-form button {
        margin-top: 0.5rem;
        padding: 0.5rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }
    .description-text {
        margin-top: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-muted);
        white-space: pre-wrap; /* ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ */
    }

    .cancellation-form {
        margin-top: 0.5rem;
    }
    .cancellation-form textarea {
        width: 100%;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        resize: vertical;
        margin-bottom: 0.5rem;
    }
    .cancellation-form button {
        padding: 0.5rem 1rem;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
    }

    .due-date {
        font-weight: 600;
    }
    .due-date-overdue {
        color: #dc3545; /* üî¥ –ö—Ä–∞—Å–Ω—ã–π */
    }
    .due-date-normal {
        color: #28a745; /* üü¢ –ó–µ–ª—ë–Ω—ã–π */
    }
</style>

<div class="container py-4">
    <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    {% if form %}
    <div class="custom-form-container">
        <h5>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h5>
        <form method="post">
            {% csrf_token %}
            <div class="form-row-gap">
                <div class="form-field">
                    {{ form.title.label_tag }}
                    {{ form.title }}
                </div>
                <div class="form-field">
                    {{ form.assigned_to.label_tag }}
                    {{ form.assigned_to }}
                </div>
                <div class="form-field">
                    {{ form.priority.label_tag }}
                    {{ form.priority }}
                </div>
                <div class="form-field">
                    {{ form.due_date.label_tag }}
                    {{ form.due_date }}
                </div>
                <div class="form-field">
                    {{ form.description.label_tag }}
                    {{ form.description }}
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
        </form>
    </div>
    {% endif %}

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á -->
    <div class="custom-table-container">
        <table>
            <thead>
                <tr>
                    <th>–ó–∞–¥–∞—á–∞</th>
                    <th>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</th>
                    <th>–ü–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫</th>
                    <th>–°—Ä–æ–∫</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                </tr>
            </thead>
            <tbody>
                {% for item in all_tasks %}
                {% with task=item.task is_created_by_ceo=item.is_created_by_ceo %}
                <tr>
                    <td>{{ task.title }}</td>
                    <td>{{ task.assigned_to.get_full_name|default:task.assigned_to.username }}</td>
                    <td>{{ task.created_by.get_full_name|default:task.created_by.username }}</td>
                    <td>
                        {% if task.due_date %}
                            {% if task.due_date < today %}
                                <!-- üî¥ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ -->
                                <span class="due-date due-date-overdue">{{ task.due_date|date:"d.m.Y" }}</span>
                            {% else %}
                                <!-- üü¢ –ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ -->
                                <span class="due-date due-date-normal">{{ task.due_date|date:"d.m.Y" }}</span>
                            {% endif %}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        {% if task.status == 'cancelled' %}
                            <!-- –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø—Ä–∏—á–∏–Ω—É -->
                            <span style="color: #dc3545; font-weight: 600;">{{ task.get_status_display }}</span>
                            {% if task.cancellation_reason and user_group in 'Lead Managers,CEO' %}
                                <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #dc3545; font-style: italic;">
                                    –ü—Ä–∏—á–∏–Ω–∞: {{ task.cancellation_reason }}
                                </div>
                            {% endif %}
                        {% else %}
                            <!-- –§–æ—Ä–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
                            <form method="post" action="{% url 'tasks:update_status' task.id %}" class="status-form">
                                {% csrf_token %}
                                <select name="status" onchange="this.form.submit();"
                                        style="background-color:
                                            {% if task.status == 'todo' %}var(--secondary);
                                            {% elif task.status == 'in_progress' %}var(--warning);
                                            {% elif task.status == 'done' %}var(--success);
                                            {% elif task.status == 'cancelled' %}var(--danger);
                                            {% else %}var(--secondary);{% endif %};
                                            color: white;">
                                    <option value="todo" {% if task.status == 'todo' %}selected{% endif %}>–ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é</option>
                                    <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
                                    <option value="done" {% if task.status == 'done' %}selected{% endif %}>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
                                    <option value="cancelled" {% if task.status == 'cancelled' %}selected{% endif %}>–û—Ç–º–µ–Ω–µ–Ω–æ</option>
                                </select>
                            </form>
                            <!-- ‚úÖ –§–æ—Ä–º–∞ –æ—Ç–º–µ–Ω—ã —Å –ø—Ä–∏—á–∏–Ω–æ–π -->
                            {% if task.status != 'cancelled' %}
                                <form method="post" action="{% url 'tasks:update_status' task.id %}" class="cancellation-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="status" value="cancelled">
                                    <textarea name="cancellation_reason" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã..." rows="2"></textarea>
                                    <button type="submit">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                </form>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {% if user_group == 'Lead Managers' or user_group == 'CEO' %}
                            {% if user_group == 'Lead Managers' and is_created_by_ceo %}
                                <!-- –õ–∏–¥ –Ω–µ –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–∞—á–∏ CEO -->
                                <span class="priority-indicator" style="background-color:
                                    {% if task.priority == 'urgent' %}#dc3545;
                                    {% elif task.priority == 'high' %}#fd7e14;
                                    {% elif task.priority == 'medium' %}#ffc107;
                                    {% elif task.priority == 'low' %}#28a745;
                                    {% else %}#6c757d;{% endif %}"></span>
                            {% else %}
                                <!-- –§–æ—Ä–º–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ -->
                                <form method="post" action="{% url 'tasks:update_priority' task.id %}" class="priority-form">
                                    {% csrf_token %}
                                    <select name="priority" onchange="this.form.submit();"
                                            style="background-color:
                                                {% if task.priority == 'urgent' %}#dc3545;
                                                {% elif task.priority == 'high' %}#fd7e14;
                                                {% elif task.priority == 'medium' %}#ffc107;
                                                {% elif task.priority == 'low' %}#28a745;
                                                {% else %}#6c757d;{% endif %};
                                                color: white; border: none; border-radius: 50%; width: 24px; height: 24px;">
                                        <option value="low" {% if task.priority == 'low' %}selected{% endif %}>–ù–∏–∑–∫–∏–π</option>
                                        <option value="medium" {% if task.priority == 'medium' %}selected{% endif %}>–°—Ä–µ–¥–Ω–∏–π</option>
                                        <option value="high" {% if task.priority == 'high' %}selected{% endif %}>–í—ã—Å–æ–∫–∏–π</option>
                                        <option value="urgent" {% if task.priority == 'urgent' %}selected{% endif %}>–°—Ä–æ—á–Ω–æ</option>
                                    </select>
                                </form>
                            {% endif %}
                        {% else %}
                            <!-- –û–±—ã—á–Ω—ã–π –∫—Ä—É–∂–æ–∫ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
                            <span class="priority-indicator" style="background-color:
                                {% if task.priority == 'urgent' %}#dc3545;
                                {% elif task.priority == 'high' %}#fd7e14;
                                {% elif task.priority == 'medium' %}#ffc107;
                                {% elif task.priority == 'low' %}#28a745;
                                {% else %}#6c757d;{% endif %}"></span>
                        {% endif %}
                    </td>
                </tr>
                <!-- ‚úÖ –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è -->
                <tr>
                    <td colspan="6" class="description-cell">
                        {% if user_group == 'Lead Managers' or user_group == 'CEO' %}
                            <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è -->
                            <form method="post" action="{% url 'tasks:update_description' task.id %}" class="description-form">
                                {% csrf_token %}
                                <textarea name="description" rows="3">{{ task.description }}</textarea>
                                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </form>
                        {% else %}
                            <!-- –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è -->
                            <div class="description-text">{{ task.description|default:"‚Äî" }}</div>
                        {% endif %}

                        <!-- ‚úÖ –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                        {% if task.status == 'cancelled' %}
                            {% if user_group == 'Lead Managers' or user_group == 'CEO' %}
                                {% if user_group == 'Lead Managers' and is_created_by_ceo %}
                                    <!-- –õ–∏–¥ –Ω–µ –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É CEO -->
                                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted);">
                                        (–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å: —Å–æ–∑–¥–∞–Ω–∞ CEO)
                                    </div>
                                {% else %}
                                    <form method="post" action="{% url 'tasks:delete_task' task.id %}" style="display: inline-block; margin-top: 0.5rem;">
                                        {% csrf_token %}
                                        <button type="submit" class="delete-btn" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')">–£–¥–∞–ª–∏—Ç—å</button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}